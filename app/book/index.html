<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="theme-color" content="#5252FF">
    <link rel="stylesheet" href="/_system/css/fontawesome/css/all.min.css">
    <link rel="stylesheet" href="/_system/css/playfulcss/playfulcss.css">
    <link rel="stylesheet" href="/_system/css/proxima.woff3.css">
    <title>Book a Pictorial | Remember Them Little</title>
</head>

<body>
    <div id="app">
        <main class="booking_test">






            <stepper steps=7 ref="stepper" inline-template>

                <div v-cloak>
                    <nav class="nav">
                        <span class="progress">
                            <div class="progress_element">
                                <span class="progress_step" :class="{'active':step >= 1}"></span>
                                <span class="step_line" :class="{'active':step >= 3}"></span>
                                <span class="progress_step" :class="{'active':step >= 3}"></span>
                                <span class="step_line" :class="{'active':step >= 4}"></span>
                                <span class="progress_step" :class="{'active':step >= 4}"></span>
                                <span class="step_line" :class="{'active':step >= 5}"></span>
                                <span class="progress_step" :class="{'active':step >= 5}"></span>
                                <span class="step_line" :class="{'active':step >= 6}"></span>
                                <span class="progress_step" :class="{'active':step >= 6}"></span>
                            </div>
                        </span>
                    </nav>

                    <!-- Step 1: Choose a Category -->
                    <transition name="fade" mode="out-in">
                        <div v-if="step==1" key="1">

                            <h4 class="h4">Step 1</h4>
                            <h1 class="h1">Choose a Package</h1>


                            <div class="category_container">
                                <a class="category" :class="{'active':$root.selected_category_id==category.category_id}"
                                    v-for="category in $root.categories" @click="$root.selected_category_id=category.category_id; next()">
                                    <img class="category_image" :src="category.category_image">
                                    <h3 class="category_title">{{category.category_name}}

                                    </h3>
                                    <p class="category_description">{{category.category_description}}
                                    </p>

                                </a>

                            </div>

                        </div>
                        <div v-if="step==2" key="2">
                            <div class="cover_image">
                                <img :src="$root.categories.find(category => category.category_id == $root.selected_category_id).category_image">
                            </div>
                            <div class="packages_container">
                                <div class="package" v-for="package in $root.filteredPackages">
                                    <h3 class="package_name">{{package.package_name}}</h3>
                                    <h4 class="package_price">P {{package.package_price}}</h4>
                                    <ul class="package_description">
                                        {{package.package_description}}
                                    </ul>
                                    <a class="choose_package" @click="$root.selected_package_id = package.package_id; next()">Choose</a>
                                </div>
                            </div>
                        </div>
                        <div v-if="step==3" key="3">
                            <h4 class="h4">Step 2</h4>
                            <h1 class="h1">Pick {{$root.booking.package.package_themes}} Theme(s)</h1>
                            <div class="themes_container">
                                <a @click="$root.preparetheme(theme.theme_id)" class="theme" :class="{'active':$root.booking.theme_ids.includes(theme.theme_id)}"
                                    v-for="theme in $root.themes">
                                    <img :src="theme.theme_image">
                                </a>

                            </div>
                            <div class="bottom_bar">
                                <div class="actions">-</div>
                                <div class="selected_themes">
                                    <a @click="$root.preparetheme($root.themes.find(theme => theme.theme_id == $root.booking.theme_ids[index]).theme_id)"
                                        class="s_theme" v-for="item,index in $root.booking.package.package_themes">
                                        <img v-if="$root.booking.theme_ids[index]!=null" :src="$root.themes.find(theme => theme.theme_id == $root.booking.theme_ids[index]).theme_image"><i
                                            v-if="$root.booking.theme_ids[index]!=null" class="fas fa-times"></i>
                                    </a>
                                </div>
                                <a class="continue_button" v-if="$root.booking.theme_ids.length == $root.booking.package.package_themes"
                                    @click="next">Continue</a>
                            </div>
                        </div>
                        <div v-if="step==4" key="4">
                            <h4 class="h4">Step 3</h4>
                            <h1 class="h1">Choose Addons</h1>

                            <div class="addon_container">
                                <table class="addon_table">
                                    <tr v-for="addon,index in $root.booking.addons">
                                        <td>{{addon.addon_type}}</td>
                                        <td>{{addon.addon_description}}</td>
                                        <td>{{addon.addon_price == 0 ? 'FREE' : 'P' + addon.addon_price}}</td>
                                        <td>
                                            <a v-if="addon.addon_price != 0 && addon.addon_description!='Upgraded to 12x16'"
                                                href="#" @click="$root.booking.addons.splice(index,1)">
                                                <i class="fas fa-times"></i>
                                            </a>
                                            <a v-if="addon.addon_price == 0 && addon.addon_type == 'PRINT' && addon.addon_description == '8x10'"
                                                href="#" @click="$root.booking.addons[index].addon_description='Upgraded to 12x16';$root.booking.addons[index].addon_price=250;">
                                                Upgrade
                                            </a>
                                            <a v-if="addon.addon_price == 250 && addon.addon_type == 'PRINT' && addon.addon_description == 'Upgraded to 12x16'"
                                                href="#" @click="$root.booking.addons[index].addon_description='8x10';$root.booking.addons[index].addon_price=0;">
                                                <i class="fas fa-times"></i>
                                            </a>
                                        </td>
                                    </tr>
                                </table><br>
                                <div style="display: flex; flex-direction: column">
                                    <button v-show="$root.checkLimit(addon)" v-for="addon in $root.addons" @click="$root.addAddon(addon)">
                                        <i class="fas fa-plus"></i>&nbsp
                                        {{addon.addon_type}} - {{addon.addon_description}} (Php
                                        {{addon.addon_price}})</button>
                                </div>
                                <br>
                                <a class="continue_button" @click="next">Continue</a>
                            </div>
                        </div>
                        <div v-if="step==5" key="5">
                            <h4 class="h4">Step 4</h4>
                            <h1 class="h1">Pick your Schedule</h1>
                            <br>
                            <calendar ref="calendar"></calendar>
                            <br>
                            <h4 class="h4">Slots available</h4>
                            
                            <div class="slots_container" v-if="$root.slots.length > 0">
                                <span @click="$root.booking.booking_time = slot" class="slot" :class="{'active':$root.booking.booking_time==slot}" v-for="slot in $root.slots">{{slot}}</span>
                            </div>
                        </div>
                    </transition>
                </div>
            </stepper>
        </main>



    </div>
    <!--External Scripts -->
    <script src="/_system/js/vendor/vue.js"></script>
    <script src="/_system/js/vendor/vue-resource@1.5.1.js"></script>
    <script src="/_system/js/components/components.js"></script>
    <script src="/_system/js/mixins/account.js"></script>
    <script src="/_system/js/mixins/category.js"></script>
    <script src="/_system/js/mixins/package.js"></script>
    <script src="/_system/js/mixins/addon.js"></script>
    <script src="/_system/js/mixins/themes.js"></script>
    <script src="/_system/js/mixins/booking.js"></script>
    <script src="/_system/js/mixins/facebook.js"></script>


    <!-- Internal Scripts -->
    <script>
        var app = new Vue({
            el: '#app',
            mixins: [accountMixin, categoryMixin, packageMixin, addonMixin, themeMixin, bookingMixin, facebookMixin],

            data: {

                categories: [],
                packages: [],
                addons: [],
                themes: [],

                selected_category_id: "",
                selected_package_id: "",
                selected_addon: "",
                selected_date: "",

                inclusions: [], // All inclusions from packages
                slots: [],

                booking: {
                    package: {},
                    addons: [], // For selected package only
                    theme_ids: [],
                    booking_date: "",
                    booking_time: "",
                    subject_name: "",
                    subject_age: "",
                    payment_method: ""
                },
            },

            computed: {

                filteredPackages: function () {
                    return this.packages.filter(package => package.category_id == app.selected_category_id)
                },
                booking_total_price: function () {
                    var package_price = this.booking.package.package_price;
                    var addons_price = 0;
                    for (x in this.booking.addons) {
                        addons_price += this.booking.addons[x].addon_price
                    }
                    return package_price + addons_price;
                }
            },

            watch: {
                selected_package_id: function () {

                    var addonArray = [];
                    for (x in this.inclusions) {
                        if (this.inclusions[x].package_id == this.selected_package_id) {

                            var fetched_addon = this.getAddon(this.inclusions[x].addon_id);
                            var free_addon = {
                                addon_id: fetched_addon.addon_id,
                                addon_type: fetched_addon.addon_type,
                                addon_description: fetched_addon.addon_description,
                                addon_price: 0,
                                addon_source: 'PACKAGE', // 'AVAILED'
                            }

                            addonArray.push(free_addon);


                        }
                    }
                    this.booking.addons = addonArray;
                    this.booking.package = this.packages.find(package => package.package_id == app.selected_package_id)

                }
                ,
                selected_date: function () {
                    this.booking.booking_date = this.selected_date;
                    console.log('D: ' + this.selected_date + " M: " + this.booking.package.package_minutes);
                    this.getOpenSlots(this.selected_date, this.booking.package.package_minutes);
                }
            },

            created: function () {

                this.loadCategories();
                this.loadPackages();
                this.loadAddons();
                this.loadInclusions();
                this.loadThemes();

            },

            methods: {
                preparetheme(id) {
                    if (this.booking.theme_ids.includes(id)) {
                        var index = this.booking.theme_ids.indexOf(id);
                        this.booking.theme_ids.splice(index, 1);
                    }
                    else
                        if (this.booking.theme_ids.length < this.booking.package.package_themes) {
                            this.booking.theme_ids.push(id)
                        }

                },
                addAddon(addon) {
                    if (this.checkLimit(addon)) {

                        var availed_addon = {
                            addon_id: addon.addon_id,
                            addon_type: addon.addon_type,
                            addon_description: addon.addon_description,
                            addon_price: addon.addon_price,
                            addon_source: 'BOOKING', // 'AVAILED'
                        }
                        this.booking.addons.push(availed_addon)
                    }

                },
                checkLimit(addon) {
                    var count = this.booking.addons.filter(inclusion => inclusion.addon_id == addon.addon_id).length;
                    return (count < addon.addon_max)
                },
                submitBooking() {
                    var formData = new FormData();
                    formData.append('package', JSON.stringify(this.booking.package));
                    formData.append('booking_addons', JSON.stringify(this.booking.addons));
                    formData.append('booking_themes', JSON.stringify(this.booking.theme_ids));
                    formData.append('booking_date', this.booking.booking_date);
                    formData.append('booking_time', this.booking.booking_time);
                    formData.append('subject_name', this.booking.subject_name);
                    formData.append('subject_age', this.booking.subject_age);
                    formData.append('account_id', this.account.account_id);
                    formData.append('token', this.account.token);
                    formData.append('payment_method', this.booking.payment_method);
                    formData.append('booking_total_price', this.booking_total_price);

                    Vue.http.post('/_system/php/api/booking/add.php', formData)
                        .then(
                            response => {
                                if (response.body.success) {
                                    console.log(response.body)
                                    window.location.href = "/app/bookings"
                                }
                                else
                                    console.error(response.body.message)
                            },
                            response => {
                                console.error(response)
                            }
                        );

                }
            }


        })
    </script>
</body>

</html>